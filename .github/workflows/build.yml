name: Build libzlink Native Libraries

on:
  push:
    branches:
      - main
      - develop
    tags:
      - '*.*'
      - 'v*'
  pull_request:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      libzlink_version:
        description: 'libzlink version to build (default: from VERSION file)'
        required: false
        type: string

env:
  ARTIFACT_RETENTION_DAYS: 30

jobs:
  read-versions:
    name: Read Version Information
    runs-on: ubuntu-22.04
    outputs:
      libzlink_version: ${{ steps.versions.outputs.libzlink_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read versions from VERSION file
        id: versions
        run: |
          LIBZLINK_VERSION=$(grep '^LIBZLINK_VERSION=' VERSION | cut -d'=' -f2)

          # Use manual input if provided, otherwise use VERSION file
          if [ -n "${{ github.event.inputs.libzlink_version }}" ]; then
            LIBZLINK_VERSION="${{ github.event.inputs.libzlink_version }}"
          fi

          echo "libzlink_version=${LIBZLINK_VERSION}" >> $GITHUB_OUTPUT

          echo "Using libzlink version: ${LIBZLINK_VERSION}"

  build-windows:
    name: Build Windows x64
    runs-on: windows-2022
    needs: read-versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install OpenSSL
        shell: pwsh
        run: |
          choco install openssl --no-progress
          $opensslRoot = "C:\Program Files\OpenSSL"
          if (Test-Path $opensslRoot) {
            echo "OPENSSL_ROOT_DIR=$opensslRoot" >> $env:GITHUB_ENV
            Write-Host "OpenSSL installed at $opensslRoot"
          } else {
            # Try fallback path
            $opensslRoot = "C:\Program Files\OpenSSL-Win64"
            if (Test-Path $opensslRoot) {
              echo "OPENSSL_ROOT_DIR=$opensslRoot" >> $env:GITHUB_ENV
            } else {
              Write-Error "OpenSSL installation failed or path incorrect"
            }
          }

      - name: Build libzlink
        shell: pwsh
        run: |
          $buildDir = "build-win-x64"
          New-Item -ItemType Directory -Force -Path $buildDir
          cd $buildDir
          cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED=ON `
            -DBUILD_STATIC=OFF `
            -DBUILD_TESTS=ON `
            -DZLINK_CXX_STANDARD=20 `
            -DOPENSSL_ROOT_DIR="$env:OPENSSL_ROOT_DIR"
          cmake --build . --config Release --parallel
          cmake --install . --config Release --prefix ../dist/windows-x64

      - name: Install Visual C++ Redistributable
        shell: pwsh
        run: |
          # Check if UCRT is available
          Write-Host "Checking for UCRT DLLs in System32..."
          $ucrtDlls = Get-ChildItem "C:\Windows\System32\ucrtbase.dll" -ErrorAction SilentlyContinue
          if ($ucrtDlls) {
            Write-Host "ucrtbase.dll found in System32"
          } else {
            Write-Host "ucrtbase.dll NOT found - installing VC++ Redistributable"
            # Download and install VC++ Redistributable
            $url = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
            $installer = "$env:TEMP\vc_redist.x64.exe"
            Invoke-WebRequest -Uri $url -OutFile $installer
            Start-Process -FilePath $installer -ArgumentList "/install", "/quiet", "/norestart" -Wait
          }

          # Also copy ucrtbase.dll to dist if available
          $distDir = "dist\windows-x64"
          $ucrtPath = "C:\Windows\System32\ucrtbase.dll"
          if (Test-Path $ucrtPath) {
            Copy-Item $ucrtPath "$distDir\ucrtbase.dll" -Force
            Write-Host "Copied ucrtbase.dll to $distDir"
          }

      - name: Check DLL dependencies
        shell: cmd
        run: |
          echo === libzlink.dll dependencies ===
          dumpbin /DEPENDENTS dist\windows-x64\libzlink.dll
          echo.
          echo === Files in dist ===
          dir /s dist\windows-x64\
        continue-on-error: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libzlink-windows-x64
          path: dist/windows-x64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-windows-arm64:
    name: Build Windows ARM64
    runs-on: windows-2022
    needs: read-versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OpenSSL (ARM64) via vcpkg
        shell: pwsh
        run: |
          vcpkg install openssl:arm64-windows-static
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          $opensslDir = "$vcpkgRoot\installed\arm64-windows-static"
          echo "OPENSSL_ROOT_DIR=$opensslDir" >> $env:GITHUB_ENV
          Write-Host "OpenSSL (ARM64) installed via vcpkg at $opensslDir"

      - name: Build libzlink
        shell: pwsh
        run: |
          $buildDir = "build-win-arm64"
          New-Item -ItemType Directory -Force -Path $buildDir
          cd $buildDir
          cmake .. `
            -G "Visual Studio 17 2022" `
            -A ARM64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED=ON `
            -DBUILD_STATIC=OFF `
            -DBUILD_TESTS=OFF `
            -DZLINK_CXX_STANDARD=20 `
            -DWITH_TLS=ON `
            -DOPENSSL_ROOT_DIR="$env:OPENSSL_ROOT_DIR" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake --build . --config Release --parallel
          cmake --install . --config Release --prefix ../dist/windows-arm64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libzlink-windows-arm64
          path: dist/windows-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-22.04
    needs: read-versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            pkg-config \
            libssl-dev

      - name: Build libzlink
        run: |
          chmod +x ./build-scripts/linux/build.sh
          ./build-scripts/linux/build.sh \
            x64 \
            "ON"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libzlink-linux-x64
          path: dist/linux-x64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-22.04-arm64
    needs: read-versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            pkg-config \
            libssl-dev

      - name: Build libzlink
        run: |
          chmod +x ./build-scripts/linux/build.sh
          ./build-scripts/linux/build.sh \
            arm64 \
            "ON"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libzlink-linux-arm64
          path: dist/linux-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-macos-intel:
    name: Build macOS x64 (Intel)
    runs-on: macos-14
    needs: read-versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OpenSSL via vcpkg
        run: |
          vcpkg install openssl:x64-osx

      - name: Build libzlink
        run: |
          export VCPKG_ROOT=$VCPKG_INSTALLATION_ROOT
          export OPENSSL_ROOT_DIR="$VCPKG_ROOT/installed/x64-osx"
          echo "Using OpenSSL from $OPENSSL_ROOT_DIR"
          
          chmod +x ./build-scripts/macos/build.sh
          ./build-scripts/macos/build.sh \
            x86_64 \
            "ON" \
            "-DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-osx -DOPENSSL_ROOT_DIR=$OPENSSL_ROOT_DIR"

      - name: Verify build
        run: |
          echo "Verifying x86_64 build..."
          file dist/macos-x86_64/libzlink.dylib
          ls -la dist/macos-x86_64/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libzlink-macos-x64
          path: dist/macos-x86_64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-macos-arm64:
    name: Build macOS ARM64 (Apple Silicon)
    runs-on: macos-15
    needs: read-versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install \
            cmake \
            pkg-config \
            openssl@3

      - name: Build libzlink
        run: |
          # Use ARM64 Homebrew for Apple Silicon
          export OPENSSL_ROOT_DIR=$(/opt/homebrew/bin/brew --prefix openssl@3)
          echo "Using OpenSSL from $OPENSSL_ROOT_DIR"
          export CMAKE_PREFIX_PATH=$OPENSSL_ROOT_DIR
          export LDFLAGS="-L$OPENSSL_ROOT_DIR/lib"
          export CPPFLAGS="-I$OPENSSL_ROOT_DIR/include"
          export PKG_CONFIG_PATH="$OPENSSL_ROOT_DIR/lib/pkgconfig"
          chmod +x ./build-scripts/macos/build.sh
          ./build-scripts/macos/build.sh \
            arm64 \
            "ON"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libzlink-macos-arm64
          path: dist/macos-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  verify:
    name: Verify Build Artifacts
    runs-on: ubuntu-22.04
    needs:
      - read-versions
      - build-windows
      - build-windows-arm64
      - build-linux
      - build-linux-arm64
      - build-macos-intel
      - build-macos-arm64
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display artifact structure
        run: |
          echo "=== Artifact Structure ==="
          find artifacts -type f -ls

      - name: Generate SHA256 checksums
        run: |
          echo "=== SHA256 Checksums ==="
          cd artifacts
          find . -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" -o -name "*.a" -o -name "*.lib" -o -name "*.h" \) -exec sha256sum {} \; | tee checksums.txt

      - name: Build summary
        run: |
          echo "## Build Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**libzlink Version:** ${{ needs.read-versions.outputs.libzlink_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Built Platforms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for platform in windows-x64 windows-arm64 linux-x64 linux-arm64 macos-x64 macos-arm64; do
            if [ -d "artifacts/libzlink-${platform}" ]; then
              echo "- ✅ ${platform}" >> $GITHUB_STEP_SUMMARY
              file_count=$(find "artifacts/libzlink-${platform}" -type f | wc -l)
              echo "  - Files: ${file_count}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ ${platform}" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat artifacts/checksums.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: artifacts/checksums.txt
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  release:
    name: Create Release
    runs-on: ubuntu-22.04
    needs:
      - read-versions
      - verify
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          cd artifacts
          # Use recursive zip to handle subdirectories and avoid 'Nothing to do' error
          zip -r libzlink-windows-x64.zip libzlink-windows-x64/
          zip -r libzlink-windows-arm64.zip libzlink-windows-arm64/
          zip -r libzlink-linux-x64.zip libzlink-linux-x64/
          zip -r libzlink-linux-arm64.zip libzlink-linux-arm64/
          zip -r libzlink-macos-x64.zip libzlink-macos-x64/
          zip -r libzlink-macos-arm64.zip libzlink-macos-arm64/
          tar -czf libzlink-windows-x64.tar.gz libzlink-windows-x64/
          tar -czf libzlink-windows-arm64.tar.gz libzlink-windows-arm64/
          tar -czf libzlink-linux-x64.tar.gz libzlink-linux-x64/
          tar -czf libzlink-linux-arm64.tar.gz libzlink-linux-arm64/
          tar -czf libzlink-macos-x64.tar.gz libzlink-macos-x64/
          tar -czf libzlink-macos-arm64.tar.gz libzlink-macos-arm64/
          ls -lh *.zip

      - name: Create source tarball
        run: |
          VERSION="${{ needs.read-versions.outputs.libzlink_version }}"
          TAG_NAME="${GITHUB_REF_NAME}"
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
          fi
          TAR_NAME="zlink-${VERSION}-source.tar.gz"
          git archive --format=tar.gz --output "${TAR_NAME}" "${TAG_NAME}"
          ls -lh "${TAR_NAME}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: libzlink ${{ needs.read-versions.outputs.libzlink_version }}
          body: |
            ## libzlink Native Libraries (zlink)

            **Version**: ${{ needs.read-versions.outputs.libzlink_version }}

            ### Features
            - **I/O Backend**: ASIO (Boost.Asio) for high-performance async I/O
            - **TLS Support**: Native TLS transport (`tls://`) and WebSocket TLS (`wss://`)
            - **WebSocket**: Full WebSocket support (`ws://`, `wss://`)
            - **Optimizations**: Link-Time Optimization (LTO) enabled for production builds
            - **Protocols**: tcp, ipc, inproc, ws, wss, tls
            - **Socket Types**: PAIR, PUB/SUB, XPUB/XSUB, DEALER/ROUTER

            ### Removed Features
            - CURVE encryption (use TLS instead)
            - REQ/REP, PUSH/PULL, STREAM socket types
            - TIPC, VMCI, PGM, NORM, UDP protocols
            - Draft API socket types

            ### Downloads
            | Platform | File |
            |----------|------|
            | Windows x64 | `libzlink-windows-x64.zip` |
            | Windows ARM64 | `libzlink-windows-arm64.zip` |
            | Linux x64 | `libzlink-linux-x64.zip` |
            | Linux ARM64 | `libzlink-linux-arm64.zip` |
            | macOS x64 (Intel) | `libzlink-macos-x64.zip` |
            | macOS ARM64 (Apple Silicon) | `libzlink-macos-arm64.zip` |

            ### Package Contents
            Each archive contains:
            - Native library (`.dll`/`.so`/`.dylib`)
            - Public headers (`include/zlink.h`, `include/zlink_utils.h`)
            - OpenSSL dependency required for TLS features

            ### Verification
            All builds have been tested with:
            - 64 unit tests (Unity framework)
            - Transport matrix tests (all socket patterns × all transports)
            - TLS/WebSocket functionality
          files: |
            artifacts/libzlink-windows-x64.zip
            artifacts/libzlink-windows-arm64.zip
            artifacts/libzlink-linux-x64.zip
            artifacts/libzlink-linux-arm64.zip
            artifacts/libzlink-macos-x64.zip
            artifacts/libzlink-macos-arm64.zip
            artifacts/libzlink-windows-x64.tar.gz
            artifacts/libzlink-windows-arm64.tar.gz
            artifacts/libzlink-linux-x64.tar.gz
            artifacts/libzlink-linux-arm64.tar.gz
            artifacts/libzlink-macos-x64.tar.gz
            artifacts/libzlink-macos-arm64.tar.gz
            artifacts/checksums/checksums.txt
            zlink-${{ needs.read-versions.outputs.libzlink_version }}-source.tar.gz
          draft: false
          prerelease: false
