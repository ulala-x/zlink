name: Build zlink Native Libraries

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  ARTIFACT_RETENTION_DAYS: 30

jobs:
  build-windows:
    name: Build Windows x64
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build zlink
        shell: pwsh
        run: |
          .\build-scripts\windows\build.ps1

      - name: Run tests
        shell: pwsh
        run: |
          .\build-scripts\windows\test.ps1

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zlink-windows-x64
          path: dist/windows-x64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-windows-arm64:
    name: Build Windows ARM64
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64_arm64

      - name: Build zlink
        shell: pwsh
        run: |
          .\build-scripts\windows\build.ps1 -Architecture arm64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zlink-windows-arm64
          path: dist/windows-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config

      - name: Build zlink
        run: |
          chmod +x ./build-scripts/linux/build.sh
          ./build-scripts/linux/build.sh x64

      - name: Run tests
        run: |
          chmod +x ./build-scripts/linux/test.sh
          ./build-scripts/linux/test.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zlink-linux-x64
          path: dist/linux-x64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config

      - name: Build zlink
        run: |
          chmod +x ./build-scripts/linux/build.sh
          ./build-scripts/linux/build.sh arm64

      - name: Run tests
        run: |
          chmod +x ./build-scripts/linux/test.sh
          ./build-scripts/linux/test.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zlink-linux-arm64
          path: dist/linux-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-macos-x64:
    name: Build macOS x64 (Intel)
    runs-on: macos-13
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install cmake pkg-config

      - name: Build zlink
        run: |
          chmod +x ./build-scripts/macos/build.sh
          ./build-scripts/macos/build.sh x86_64

      - name: Run tests
        run: |
          chmod +x ./build-scripts/macos/test.sh
          ./build-scripts/macos/test.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zlink-macos-x64
          path: dist/macos-x86_64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-macos-arm64:
    name: Build macOS ARM64 (Apple Silicon)
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install cmake pkg-config

      - name: Build zlink
        run: |
          chmod +x ./build-scripts/macos/build.sh
          ./build-scripts/macos/build.sh arm64

      - name: Run tests
        run: |
          chmod +x ./build-scripts/macos/test.sh
          ./build-scripts/macos/test.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zlink-macos-arm64
          path: dist/macos-arm64/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  verify:
    name: Verify Build Artifacts
    runs-on: ubuntu-22.04
    needs:
      - build-windows
      - build-windows-arm64
      - build-linux
      - build-linux-arm64
      - build-macos-x64
      - build-macos-arm64
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display artifact structure
        run: |
          echo "=== Artifact Structure ==="
          find artifacts -type f -ls

      - name: Generate SHA256 checksums
        run: |
          echo "=== SHA256 Checksums ==="
          cd artifacts
          find . -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" -o -name "*.a" -o -name "*.lib" \) -exec sha256sum {} \; | tee checksums.txt

      - name: Build summary
        run: |
          echo "## Build Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Built Platforms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for platform in windows-x64 windows-arm64 linux-x64 linux-arm64 macos-x64 macos-arm64; do
            if [ -d "artifacts/zlink-${platform}" ]; then
              echo "- ✅ ${platform}" >> $GITHUB_STEP_SUMMARY
              file_count=$(find "artifacts/zlink-${platform}" -type f | wc -l)
              echo "  - Files: ${file_count}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ ${platform}" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat artifacts/checksums.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: artifacts/checksums.txt
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  release:
    name: Create Release
    runs-on: ubuntu-22.04
    needs:
      - verify
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          cd artifacts
          for platform in windows-x64 windows-arm64 linux-x64 linux-arm64 macos-x64 macos-arm64; do
            if [ -d "zlink-${platform}" ]; then
              zip -j "zlink-${platform}.zip" zlink-${platform}/*
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: zlink ${{ github.ref_name }}
          body: |
            ## zlink Native Libraries

            **Version:** ${{ github.ref_name }}

            ### Downloads
            | Platform | File |
            |----------|------|
            | Windows x64 | `zlink-windows-x64.zip` |
            | Windows ARM64 | `zlink-windows-arm64.zip` |
            | Linux x64 | `zlink-linux-x64.zip` |
            | Linux ARM64 | `zlink-linux-arm64.zip` |
            | macOS x64 (Intel) | `zlink-macos-x64.zip` |
            | macOS ARM64 (Apple Silicon) | `zlink-macos-arm64.zip` |
          files: |
            artifacts/zlink-windows-x64.zip
            artifacts/zlink-windows-arm64.zip
            artifacts/zlink-linux-x64.zip
            artifacts/zlink-linux-arm64.zip
            artifacts/zlink-macos-x64.zip
            artifacts/zlink-macos-arm64.zip
            artifacts/checksums/checksums.txt
          draft: false
          prerelease: false
