name: Release Core Conan Package

on:
  push:
    tags:
      - 'core/v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Core version to publish (e.g. 0.9.0). Empty means VERSION file.'
        required: false
        type: string
      conan_remote:
        description: 'Conan remote name (default: zlink-remote)'
        required: false
        default: zlink-remote
        type: string
      publish:
        description: 'Upload package to remote'
        required: true
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  conan:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Conan 2
        run: |
          python -m pip install --upgrade pip
          python -m pip install "conan>=2.0,<3.0"
          conan --version

      - name: Resolve version
        id: ver
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "${VERSION}" ]; then
            VERSION=$(grep '^LIBZLINK_VERSION=' VERSION | cut -d'=' -f2)
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Validate conandata has source for version
        shell: bash
        run: |
          VERSION="${{ steps.ver.outputs.version }}"
          if ! grep -q "\"${VERSION}\":" core/packaging/conan/conandata.yml; then
            echo "conandata.yml does not contain source for version ${VERSION}" >&2
            exit 1
          fi

      - name: Create Conan package
        run: |
          cd core/packaging/conan
          conan profile detect --force
          conan create . --version "${{ steps.ver.outputs.version }}" --build=missing

      - name: Upload Conan package
        if: github.event_name == 'push' || github.event.inputs.publish == 'true'
        env:
          CONAN_REMOTE_URL: ${{ secrets.CONAN_REMOTE_URL }}
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_LOGIN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        run: |
          if [ -z "${CONAN_REMOTE_URL}" ] || [ -z "${CONAN_LOGIN_USERNAME}" ] || [ -z "${CONAN_PASSWORD}" ]; then
            echo "CONAN_REMOTE_URL, CONAN_LOGIN_USERNAME, CONAN_PASSWORD secrets are required" >&2
            exit 1
          fi

          REMOTE_NAME="${{ github.event.inputs.conan_remote }}"
          if [ -z "${REMOTE_NAME}" ]; then
            REMOTE_NAME="zlink-remote"
          fi

          conan remote add "${REMOTE_NAME}" "${CONAN_REMOTE_URL}" --force
          conan remote login "${REMOTE_NAME}" "${CONAN_LOGIN_USERNAME}" -p "${CONAN_PASSWORD}"

          PKG_REF="zlink/${{ steps.ver.outputs.version }}"
          conan upload "${PKG_REF}" -r "${REMOTE_NAME}" --confirm --only-recipe
          conan upload "${PKG_REF}" -r "${REMOTE_NAME}" --confirm
