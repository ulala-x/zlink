# RFC: ZMP (Zlink Message Protocol) v2.0 Specification

이 문서는 **zlink** 프로젝트에서 사용하는 전용 메시징 프로토콜인 **ZMP v2.0** 사양을 기술합니다.

## 1. 설계 철학 (Modernization & Simplicity)

ZMP는 표준 ZMTP의 복잡한 핸드셰이크와 가변 길이 인코딩을 배제하고, 현대적인 고성능 분산 시스템에 최적화된 **"Minimalist & High-Performance"** 프로토콜을 지향합니다.

*   **ZMTP 비호환**: 표준 libzlink와는 호환되지 않으며, 오직 zlink 노드 간의 통신을 위해 최적화되었습니다.
*   **고정형 헤더**: 모든 제어/데이터 프레임은 고정된 8바이트 헤더를 사용하여 파싱 오버헤드를 극도로 낮췄습니다.
*   **현대적 확장성**: 보안, 압축, 언어별 바인딩을 위한 메타데이터를 효율적으로 실어 나를 수 있는 구조를 가집니다.

## 2. 프레임 구조 (ZMP Peer-to-Peer)

zlink 소켓 간 통신 시 사용하는 기본 프레임 구조입니다.

### 2.1 헤더 레이아웃 (8 Bytes 고정)

```text
 0               1               2               3
 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     MAGIC     |    VERSION    |     FLAGS     |    RESERVED   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        PAYLOAD SIZE (32)                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

*   **MAGIC**: `0x5A`
*   **VERSION**: `0x02`
*   **FLAGS**: MORE(`0x01`), CONTROL(`0x02`), IDENTITY(`0x04`), SUBSCRIBE(`0x08`), CANCEL(`0x10`)
*   **PAYLOAD SIZE**: 32비트 정수 (Network Byte Order)

---

## 3. STREAM 소켓 전용: Wire Protocol (Length-Prefixed)

STREAM 소켓은 ZMP를 사용하지 않는 외부 클라이언트와의 통신을 위해 **별도의 간소화된 프레이밍**을 사용합니다. 이는 클라이언트 측에서 구현하기 매우 쉽도록 설계되었습니다.

### 3.1 전송 형식 (Wire Format)

네트워크(TCP/WS)를 통해 실제로 오가는 데이터의 형식입니다.

```text
+----------------------------+-----------------------------+
|   Length (4 Bytes, BE)     |      Payload (N Bytes)      |
+----------------------------+-----------------------------+
```

*   **Length**: 뒤따르는 페이로드의 순수 길이를 나타냅니다. (4바이트 Big Endian)
*   **Payload**: 실제 애플리케이션 데이터입니다.

### 3.2 구현 의도
- **클라이언트 구현 단순화**: 복잡한 상태 머신 없이 `read(4) -> read(len)` 패턴만으로 모든 언어에서 즉시 연동 가능합니다.
- **스트림 투명성**: 애플리케이션은 메시지 단위를 인지하면서도, 네트워크상에서는 최소한의 프레이밍 오버헤드만 가집니다.